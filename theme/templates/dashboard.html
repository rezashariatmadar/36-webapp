{% extends "base.html" %}
{% load i18n %}

{% block title %}آنالیز و آمار - ۳۶{% endblock %}

{% block content %}
<div class="space-y-8 animate-fade-in">

    <!-- Header -->
    <div class="flex flex-col md:flex-row justify-between items-end gap-4 pb-4 border-b border-white/5">
        <div>
            <h1 class="text-3xl md:text-4xl font-black text-white mb-2 tracking-tight">داشبورد</h1>
            <p class="text-white/50 font-medium text-sm md:text-base">نگاهی کلی به وضعیت کافه و فضای کار</p>
        </div>
        <div class="flex items-center gap-3">
            <div class="px-4 py-2 rounded-full glass-chip text-xs md:text-sm font-mono ltr text-white/70">{{ now|date:"Y/m/d" }}</div>
            <button onclick="location.reload()" class="btn-apple-glass w-10 h-10 p-0 rounded-full flex items-center justify-center hover:rotate-180 transition-transform duration-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
            </button>
        </div>
    </div>

    <!-- 1. Top Stats Grid -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 fade-in-once">
        <!-- Cafe Rev -->
        <div class="material-glass glass-sheen hover-lift p-6 rounded-[1.5rem] relative overflow-hidden group hover:bg-white/10 transition-colors duration-300">
            <div class="absolute -top-10 -right-10 w-32 h-32 bg-primary/20 blur-[50px] -z-10 group-hover:bg-primary/30 transition-all"></div>
            <div class="text-label mb-2 text-white/60">درآمد کل کافه</div>
            <div class="text-3xl font-black text-white mb-2 tracking-tight format-price">{{ cafe_total }}</div>
            <div class="flex items-center gap-2">
                <div class="w-1.5 h-1.5 rounded-full bg-accent"></div>
                <div class="text-xs font-bold text-white/80">امروز: <span class="format-price text-accent">{{ cafe_today }}</span></div>
            </div>
        </div>

        <!-- Cowork Rev -->
        <div class="material-glass glass-sheen hover-lift p-6 rounded-[1.5rem] relative overflow-hidden group hover:bg-white/10 transition-colors duration-300">
            <div class="absolute -top-10 -right-10 w-32 h-32 bg-secondary/20 blur-[50px] -z-10 group-hover:bg-secondary/30 transition-all"></div>
            <div class="text-label mb-2 text-white/60">درآمد فضای کار</div>
            <div class="text-3xl font-black text-white mb-2 tracking-tight format-price">{{ cowork_total }}</div>
            <div class="text-xs text-white/40 font-medium">مجموع تراکنش‌ها</div>
        </div>

        <!-- Occupancy -->
        <div class="material-glass glass-sheen hover-lift p-6 rounded-[1.5rem] relative overflow-hidden hover:bg-white/10 transition-colors duration-300">
            <div class="text-label mb-2 text-white/60">نرخ اشغال فضا</div>
            <div class="flex items-end gap-2 mb-3">
                <div class="text-3xl font-black text-white tracking-tight">{{ occupancy_rate }}<span class="text-lg align-top opacity-50 font-normal">%</span></div>
            </div>
            <div class="w-full bg-white/10 rounded-full h-1.5 overflow-hidden">
                <div class="bg-gradient-to-r from-primary to-accent h-full rounded-full transition-all duration-1000 shadow-[0_0_10px_rgba(10,132,255,0.5)]" style="width: {{ occupancy_rate }}%"></div>
            </div>
        </div>

        <!-- Active Bookings -->
        <div class="material-glass glass-sheen hover-lift p-6 rounded-[1.5rem] relative overflow-hidden hover:bg-white/10 transition-colors duration-300">
            <div class="text-label mb-2 text-white/60">رزروهای فعال</div>
            <div class="text-3xl font-black text-white mb-2 tracking-tight">{{ active_bookings }}</div>
            <div class="text-xs text-white/40 font-medium">از مجموع {{ total_spaces }} فضا</div>
        </div>
    </div>

    <!-- 2. Detailed Tables Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 fade-in-once">

        <!-- Top Items -->
        <div class="material-glass glass-sheen hover-lift rounded-[2rem] overflow-hidden flex flex-col h-full border border-white/10 shadow-lg">
            <div class="p-6 border-b border-white/5 flex justify-between items-center glass-header">
                <h3 class="font-bold text-lg text-white tracking-tight">پرفروش‌ترین‌های کافه</h3>
                <span class="px-2.5 py-1 rounded-full glass-chip text-[10px] font-bold text-white/70 tracking-wider">TOP 5</span>
            </div>
            <div class="p-0 overflow-x-auto">
                <table class="w-full text-sm text-right">
                    <thead>
                        <tr class="text-white/40 border-b border-white/5 text-xs uppercase tracking-wider">
                            <th class="py-4 pr-6 font-medium">نام آیتم</th>
                            <th class="py-4 text-center font-medium">تعداد</th>
                            <th class="py-4 pl-6 text-left font-medium">درآمد</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-white/5">
                        {% for item in top_items %}
                            <tr class="group hover:bg-white/5 transition-colors duration-200">
                                <td class="py-4 pr-6 font-bold text-white group-hover:text-primary transition-colors">{{ item.menu_item__name }}</td>
                                <td class="py-4 text-center">
                                    <span class="inline-flex items-center justify-center h-6 px-2.5 rounded-full bg-white/5 text-xs font-bold text-white/80 border border-white/5">{{ item.total_qty }}</span>
                                </td>
                                <td class="py-4 pl-6 text-left font-mono text-white/70 format-price">{{ item.total_rev }}</td>
                            </tr>
                        {% empty %}
                            <tr><td colspan="3" class="text-center opacity-30 py-12 text-sm">داده‌ای یافت نشد</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Top Cowork Users -->
        <div class="material-glass glass-sheen hover-lift rounded-[2rem] overflow-hidden flex flex-col h-full border border-white/10 shadow-lg">
            <div class="p-6 border-b border-white/5 flex justify-between items-center glass-header">
                <h3 class="font-bold text-lg text-white tracking-tight">مشتریان وفادار (فضای کار)</h3>
            </div>
            <div class="p-0 overflow-x-auto">
                <table class="w-full text-sm text-right">
                    <thead>
                        <tr class="text-white/40 border-b border-white/5 text-xs uppercase tracking-wider">
                            <th class="py-4 pr-6 font-medium">کاربر</th>
                            <th class="py-4 text-center font-medium">رزرو</th>
                            <th class="py-4 pl-6 text-left font-medium">پرداختی</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-white/5">
                        {% for member in top_cowork_members %}
                            <tr class="group hover:bg-white/5 transition-colors duration-200">
                                <td class="py-4 pr-6">
                                    <div class="font-bold text-white group-hover:text-secondary transition-colors">{{ member.user__full_name|default:"کاربر بدون نام" }}</div>
                                    <div class="text-[10px] opacity-40 font-mono tracking-wider mt-0.5">{{ member.user__phone_number }}</div>
                                </td>
                                <td class="py-4 text-center">
                                    <span class="font-black text-secondary text-lg">{{ member.total_bookings }}</span>
                                </td>
                                <td class="py-4 pl-6 text-left font-mono text-secondary/80 format-price">{{ member.total_spent }}</td>
                            </tr>
                        {% empty %}
                            <tr><td colspan="3" class="text-center opacity-30 py-12 text-sm">داده‌ای یافت نشد</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Top Cafe Buyers -->
        <div class="material-glass glass-sheen hover-lift rounded-[2rem] overflow-hidden flex flex-col h-full border border-white/10 shadow-lg lg:col-span-2">
            <div class="p-6 border-b border-white/5 glass-header">
                <h3 class="font-bold text-lg text-white tracking-tight">مشتریان برتر کافه</h3>
            </div>
            <div class="p-0 overflow-x-auto">
                <table class="w-full text-sm text-right">
                    <thead>
                        <tr class="text-white/40 border-b border-white/5 text-xs uppercase tracking-wider">
                            <th class="py-4 pr-6 font-medium">مشتری</th>
                            <th class="py-4 pl-6 text-left font-medium">مجموع خرید</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-white/5">
                        {% for buyer in top_cafe_buyers %}
                            <tr class="group hover:bg-white/5 transition-colors duration-200">
                                <td class="py-4 pr-6 flex items-center gap-4">
                                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-primary/80 to-primary/20 flex items-center justify-center text-sm font-black shadow-lg shadow-primary/20 text-white border border-white/10">
                                        {{ buyer.user__full_name|slice:":1" }}
                                    </div>
                                    <div>
                                        <div class="font-bold text-white group-hover:text-primary transition-colors">{{ buyer.user__full_name|default:"مشتری حضوری" }}</div>
                                        <div class="text-[10px] opacity-40 font-mono tracking-wider mt-0.5">{{ buyer.user__phone_number }}</div>
                                    </div>
                                </td>
                                <td class="py-4 pl-6 text-left font-black text-primary text-lg format-price">{{ buyer.total_spent }}</td>
                            </tr>
                        {% empty %}
                            <tr><td colspan="2" class="text-center opacity-30 py-12 text-sm">داده‌ای یافت نشد</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

    </div>
</div>
{% endblock %}
